{% extends "common/system-base.html" %}
{% load static %}

{% block title %}Detalles de la Auditoría{% endblock title %}
{% block page_title %}Detalles de la Auditoría{% endblock page_title %}

{% block main_content %}
<link rel="stylesheet" href="{% static 'users/styles.css' %}">
<style>
    .icon-img {
        width: 16px;
        height: 16px;
        vertical-align: middle;
        margin-right: 5px;
    }

    .toolbar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
        gap: 8px;
    }

    .download-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 14px;
    }

    .download-button:hover {
        background-color: #0056b3;
    }

    /* Estilo del modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        justify-content: center;
        align-items: flex-start;
        padding-top: 80px;
        z-index: 9999;
    }

    .modal-content {
        background-color: white;
        padding: 30px 40px;
        border: 1px solid #ddd;
        width: 500px;
        min-height: 260px;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.2s ease-in-out;
    }

    /* Animación de entrada*/
    @keyframes fadeIn {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }


    .modal-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
    }

    .modal-body {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }

    .modal-footer {
        text-align: right;
    }

    input[type="file"].form-control {
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-label {
        font-weight: 500;
        font-size: 14px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: black;
    }

    .folder-structure {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #fafafa;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .modal-content {
        background-color: white;
        margin: 8% auto;
        padding: 30px 40px;
        border: 1px solid #ddd;
        width: 500px;
        /* Aumentado desde 400px */
        min-height: 220px;
        /* Altura mínima agregada */
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }
</style>

<div class="container">
    <h4>{{ nombre_auditoria }}</h4>

    <!-- Toolbar -->
    <div class="toolbar">
        <button onclick="handleExportCuentas()" class="download-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon-img" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M.5 9.9a.5.5 0 0 1 .5-.4h4.7V1a.5.5 0 0 1 1 0v8.5h4.7a.5.5 0 0 1 .4.9l-5 5a.5.5 0 0 1-.8 0l-5-5z" />
            </svg>
            Exportar Cuentas Contables
        </button>

        <button onclick="openImportModal()" class="download-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon-img" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 6.1a.5.5 0 0 1 .5.4v4.7h3.5a.5.5 0 0 1 0 1H1v3.5a.5.5 0 0 1-1 0v-4a.5.5 0 0 1 .5-.5z" />
                <path
                    d="M15 0a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1h-5v1h3.5a.5.5 0 0 1 0 1H10v2.5a.5.5 0 0 1-1 0V9h-1.5a.5.5 0 0 1 0-1H9V6a1 1 0 0 1 1-1h5V1a1 1 0 0 1 1-1z" />
            </svg>
            Importar
        </button>
    </div>

    <!-- Carpeta -->
    <div class="folder-structure">
        {{ estructura_html|safe }}
    </div>
</div>

<!-- MODAL IMPORTAR -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeImportModal()">&times;</span>

        <div id="import-main-section">
            <div class="modal-header">Importar Cuentas Contables</div>
            <div class="modal-body">
                <button onclick="goToImportUpload('estado-financiero')" class="download-button w-full">
                    Estado Financiero
                </button>
            </div>
        </div>

        <div id="import-upload-section" style="display: none;">
            <div class="modal-header" id="importUploadTitle">Importar</div>
            <form id="uploadForm" enctype="multipart/form-data" onsubmit="submitImportForm(event)">
                {% csrf_token %}
                <div class="modal-body">
                    <label for="archivo_excel" class="form-label">Selecciona un archivo Excel:</label>
                    <input type="file" name="archivo_excel" id="archivo_excel" accept=".xlsx,.xls" required
                        class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="download-button">Subir</button>
                    <button type="button" class="download-button" style="background-color: grey;"
                        onclick="goBackToImportMain()">Volver</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL EXPORTAR -->
<div id="exportModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeExportModal()">&times;</span>
        <div class="modal-header">Confirmar Exportación</div>
        <div class="modal-body">
            <button onclick="exportFile('estados-financieros')" class="download-button w-full">Estados Financieros</button>
        </div>
    </div>
</div>

<script>
    const audit_id = "{{ audit.id }}";

    function toggleFolder(folderId) {
        const element = document.getElementById(folderId);
        if (element) {
            const isVisible = element.style.display === "block";
            element.style.display = isVisible ? "none" : "block";
        }
    }

    function openImportModal() {
        document.getElementById("importModal").style.display = "block";
        document.getElementById("import-main-section").style.display = "block";
        document.getElementById("import-upload-section").style.display = "none";
    }

    function closeImportModal() {
        document.getElementById("importModal").style.display = "none";
        goBackToImportMain();
    }

    function goBackToImportMain() {
        document.getElementById("import-main-section").style.display = "block";
        document.getElementById("import-upload-section").style.display = "none";
    }

    function goToImportUpload(tipo) {
        document.getElementById("importUploadTitle").innerText = "Importar Estado Financiero";
        document.getElementById("import-main-section").style.display = "none";
        document.getElementById("import-upload-section").style.display = "block";
    }

    function handleExportCuentas() {
        document.getElementById("exportModal").style.display = "block";
    }

    function exportFile(tipo) {
        const url = `/auditoria/detalle/${audit_id}/exportar/${tipo}/`;
        window.location.href = url;
    }

    function submitImportForm(event) {
        event.preventDefault();
        const form = document.getElementById("uploadForm");
        const formData = new FormData(form);

        fetch("{% url 'importar_cuentas_contables' audit_id=audit.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("✅ " + data.message);
                    closeImportModal();
                } else {
                    alert("❌ Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("❌ Error inesperado al subir el archivo.");
            });
    }

    window.onclick = function (event) {
        const importModal = document.getElementById("importModal");
        const exportModal = document.getElementById("exportModal");

        if (event.target === importModal) {
            importModal.style.display = "none";
        }
        if (event.target === exportModal) {
            exportModal.style.display = "none";
        }
    };
</script>
{% endblock main_content %}